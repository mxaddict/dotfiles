#!/usr/bin/env bash
# vi: ft=bash

rofi_kill() {
    pkill rofi
}

rofi_kill && exit 0

history="$HOME/.local/share/qalc.history"
if [ ! -f "$history" ]; then
    touch "$history"
fi

qalc -e "1 BTC" &

regex='[=≈]\s*\K.*'
answer=""
answer_raw=""
while :; do
    rofi_result=$(tac "$history" | head -5000 | rofi -case-smart -dmenu -p Calc -filter "$answer")

    exit_code=$?

    if test "$exit_code" = "1"; then
        exit 0
    fi

    if [[ "$rofi_result" =~ .*[=≈].* ]]; then
        echo "$rofi_result" | grep -oP "$regex" | wl-copy
        exit 0
    else
        answer_raw=$(qalc "$rofi_result")
        answer=$(echo "$answer_raw" | grep -oP "$regex")
        echo "$answer" | wl-copy
        echo "$answer_raw" >>"$history"
    fi
done
