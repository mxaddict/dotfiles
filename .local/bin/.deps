#!/usr/bin/env bash
# vi: ft=bash
# WARN: make sure things are sure
set -euo pipefail

GREEN_CHECK="\e[32m  âœ…\e[0m"

if command -v pacman >/dev/null; then
    if ! command -v paru >/dev/null; then
        echo -e "$GREEN_CHECK Installing paru (AUR helper)..."
        sudo pacman -S base-devel rustup git --needed --noconfirm >/dev/null 2>&1
        rustup install stable >/dev/null 2>&1
        rustup default stable >/dev/null 2>&1
        git clone https://aur.archlinux.org/paru.git /tmp/paru >/dev/null 2>&1
        pwd=$(pwd)
        cd /tmp/paru || exit
        makepkg -si --noconfirm >/dev/null 2>&1
        cd "$pwd" || exit
    fi

    echo -e "$GREEN_CHECK Updating Arch Linux system packages..."
    paru -Syu --noconfirm >/dev/null 2>&1 || true
    echo -e "$GREEN_CHECK Installing core system packages (Arch Linux)..."
    paru -S --needed --noconfirm \
        adw-gtk-theme \
        alacritty \
        alsa-firmware \
        alsa-utils \
        ardour \
        avahi \
        bat \
        bear \
        bind \
        bluetui \
        bluez \
        bluez-utils \
        breeze \
        brightnessctl \
        btop \
        chromium \
        cmatrix \
        cronie \
        cups \
        cups-pdf \
        curl \
        dex \
        duf \
        dysk \
        ethtool \
        eza \
        fastfetch \
        fd \
        firefox \
        fish \
        fprintd \
        fwupd \
        fzf \
        gemini-cli \
        ghostscript \
        git \
        gnu-free-fonts \
        grim \
        gsfonts \
        gst-libav \
        gst-plugins-bad \
        gst-plugins-base \
        gst-plugins-good \
        gst-plugins-ugly \
        hypridle \
        hyprland \
        hyprlock \
        hyprpaper \
        hyprpicker \
        hyprpolkitagent \
        hyprqt6engine \
        imv \
        jq \
        kanata \
        kooha \
        lazygit \
        libadwaita \
        libnotify \
        ly \
        man-db \
        mpv \
        nautilus \
        neovim \
        networkmanager \
        nmap \
        nodejs \
        noto-fonts-cjk \
        noto-fonts-emoji \
        npm \
        nss-mdns \
        nwg-displays \
        nwg-look \
        papirus-icon-theme \
        pass \
        pass-otp \
        pipewire \
        pipewire-alsa \
        pipewire-jack \
        pipewire-pulse \
        power-profiles-daemon \
        python-tldextract \
        qalculate-qt \
        qt5-wayland \
        qt6-wayland \
        reflector \
        ripgrep \
        rofi \
        rsync \
        rustup \
        sbctl \
        slurp \
        snapshot \
        sof-firmware \
        speedtest-cli \
        starship \
        stow \
        swaync \
        swayosd \
        tealdeer \
        terminus-font \
        thunderbird \
        tmux \
        traceroute \
        ttf-hack \
        ttf-hack-nerd \
        ttf-noto-nerd \
        ttf-roboto \
        ttf-roboto-mono \
        ttf-roboto-mono-nerd \
        ufw \
        unzip \
        usbutils \
        vieb-bin \
        waybar \
        wget \
        wireless-regdb \
        wiremix \
        wireplumber \
        wl-clipboard \
        woff2-font-awesome \
        wtype \
        xdg-desktop-portal-gtk \
        xdg-desktop-portal-hyprland \
        yt-dlp \
        zerotier-one \
        zoxide >/dev/null 2>&1

    export DOTROOT="$HOME/.files/.root"
    declare -a FILES=(
        "etc/kanata.kbd"
        "etc/ly/config.ini"
        "etc/mkinitcpio.conf"
        "etc/mkinitcpio.d/linux.preset"
        "etc/pacman.conf"
        "etc/systemd/logind.conf"
        "etc/systemd/sleep.conf"
        "etc/systemd/system/power-check.service"
        "etc/systemd/system/power-check.timer"
        "etc/udev/rules.d/99-power-profiles.rules"
        "etc/vconsole.conf"
        "usr/bin/auto-power-profile"
    )

    for FILE_PATH in "${FILES[@]}"; do
        sudo cp "$DOTROOT/$FILE_PATH" "/$FILE_PATH"
    done

    echo -e "$GREEN_CHECK Regenerating initramfs..."
    sudo mkinitcpio -P >/dev/null 2>&1
    echo -e "$GREEN_CHECK Synchronizing filesystem..."
    sudo sync >/dev/null 2>&1

    echo -e "$GREEN_CHECK Reloading udev rules..."
    sudo udevadm control --reload-rules >/dev/null 2>&1
    echo -e "$GREEN_CHECK Triggering udev events..."
    sudo udevadm trigger >/dev/null 2>&1

    echo -e "$GREEN_CHECK Disabling display-manager.service..."
    sudo systemctl disable display-manager.service >/dev/null 2>&1 || true

    echo -e "$GREEN_CHECK Enabling ly@tty2.service..."
    sudo systemctl enable ly@tty2.service >/dev/null 2>&1

    echo -e "$GREEN_CHECK Enabling NetworkManager.service..."
    sudo systemctl enable NetworkManager.service >/dev/null 2>&1

    echo -e "$GREEN_CHECK Enabling NetworkManager-dispatcher.service..."
    sudo systemctl enable NetworkManager-dispatcher.service >/dev/null 2>&1

    echo -e "$GREEN_CHECK Enabling avahi-daemon.service..."
    sudo systemctl enable avahi-daemon.service >/dev/null 2>&1

    echo -e "$GREEN_CHECK Enabling bluetooth.service..."
    sudo systemctl enable bluetooth.service >/dev/null 2>&1

    echo -e "$GREEN_CHECK Enabling kanata.service..."
    sudo systemctl enable kanata.service >/dev/null 2>&1

    echo -e "$GREEN_CHECK Enabling power-check.timer..."
    sudo systemctl enable power-check.timer >/dev/null 2>&1

    echo -e "$GREEN_CHECK Enabling power-profiles-daemon.service..."
    sudo systemctl enable power-profiles-daemon.service >/dev/null 2>&1

    echo -e "$GREEN_CHECK Enabling ufw.service..."
    sudo systemctl enable ufw.service >/dev/null 2>&1

    echo -e "$GREEN_CHECK Configuring UFW firewall rules..."
    sudo ufw allow http >/dev/null 2>&1
    sudo ufw allow https >/dev/null 2>&1
    sudo ufw allow ssh >/dev/null 2>&1
    sudo ufw allow mdns >/dev/null 2>&1
    sudo ufw allow 42069 >/dev/null 2>&1                                      # COT
    sudo ufw allow 9993/udp >/dev/null 2>&1                                   # zerotier port
    sudo ufw allow proto udp from any to any port 27031:27036 >/dev/null 2>&1 # steam
    sudo ufw allow proto tcp from any to any port 27040 >/dev/null 2>&1       # steam

    echo -e "$GREEN_CHECK Enabling UFW..."
    echo "y" | sudo ufw enable >/dev/null 2>&1
fi

if command -v dnf >/dev/null; then
    echo -e "$GREEN_CHECK Installing core system packages (Fedora)..."
    sudo dnf install -y \
        alacritty \
        bat \
        eza \
        fastfetch \
        fd-find \
        fish \
        fzf \
        git \
        neovim \
        nodejs \
        npm \
        ripgrep \
        stow \
        tealdeer \
        tmux \
        unzip \
        zoxide >/dev/null 2>&1
fi

if command -v brew >/dev/null; then
    echo -e "$GREEN_CHECK Installing core system packages (macOS/Homebrew)..."
    CI=1 brew install \
        alacritty \
        bat \
        bear \
        btop \
        eza \
        fastfetch \
        fd \
        fish \
        fzf \
        git \
        lazygit \
        neovim \
        nodejs \
        npm \
        ripgrep \
        rustup \
        starship \
        stow \
        tealdeer \
        tmux \
        unzip \
        zoxide >/dev/null 2>&1
fi

if command -v apt-get >/dev/null; then
    echo -e "$GREEN_CHECK Updating APT package lists..."
    sudo apt-get update >/dev/null 2>&1

    echo -e "$GREEN_CHECK Installing core system packages (APT)..."
    sudo apt-get install -y \
        alacritty \
        bat \
        bear \
        btop \
        duf \
        eza \
        fastfetch \
        fd-find \
        fish \
        fzf \
        git \
        libssl-dev \
        neovim \
        nodejs \
        npm \
        pkg-config \
        python3 \
        python3-venv \
        ripgrep \
        rustup \
        stow \
        tealdeer \
        tmux \
        unzip \
        zoxide >/dev/null 2>&1
fi

if command -v nvim >/dev/null; then
    echo -e "$GREEN_CHECK Setting up Neovim symlinks..."
    sudo ln -sf "$(which nvim)" "/usr/local/bin/vi" >/dev/null 2>&1
    sudo ln -sf "$(which nvim)" "/usr/local/bin/vim" >/dev/null 2>&1
    sudo ln -sf "$(which nvim)" "/usr/local/bin/v" >/dev/null 2>&1
fi

echo -e "$GREEN_CHECK Installing Rust stable toolchain..."
rustup install stable >/dev/null 2>&1
rustup default stable >/dev/null 2>&1

echo -e "$GREEN_CHECK Installing Rust tools (quoty)..."
cargo install quoty >/dev/null 2>&1
echo -e "$GREEN_CHECK Installing Rust tools (fnm)..."
cargo install fnm >/dev/null 2>&1

echo -e "$GREEN_CHECK Dependency installation complete."
