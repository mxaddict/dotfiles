#!/usr/bin/env bash
# vi: ft=bash
# WARN: make sure things are sure
set -euo pipefail

if command -v pacman >/dev/null; then
    if ! command -v paru >/dev/null; then
        sudo pacman -S base-devel rustup git --needed --noconfirm
        rustup install stable
        rustup default stable
        git clone https://aur.archlinux.org/paru.git /tmp/paru
        pwd=$(pwd)
        cd /tmp/paru || exit
        makepkg -si --noconfirm
        cd "$pwd" || exit
    fi

    paru -Syu --noconfirm
    paru -S --needed --noconfirm \
        adw-gtk-theme \
        alacritty \
        alsa-firmware \
        alsa-utils \
        ardour \
        avahi \
        bat \
        bear \
        bind \
        blueman \
        bluez \
        bluez-utils \
        breeze \
        brightnessctl \
        btop \
        chromium \
        cmatrix \
        cronie \
        cups \
        cups-pdf \
        curl \
        dex \
        duf \
        dysk \
        ethtool \
        eza \
        fastfetch \
        fd \
        firefox \
        fish \
        fprintd \
        fwupd \
        fzf \
        gemini-cli \
        ghostscript \
        git \
        gnu-free-fonts \
        grim \
        gsfonts \
        gst-libav \
        gst-plugins-bad \
        gst-plugins-base \
        gst-plugins-good \
        gst-plugins-ugly \
        hypridle \
        hyprland \
        hyprlock \
        hyprpaper \
        hyprpicker \
        hyprpolkitagent \
        hyprqt6engine \
        imv \
        jq \
        kanata \
        kooha \
        lazygit \
        libadwaita \
        libnotify \
        ly \
        man-db \
        mpv \
        nautilus \
        neovim \
        networkmanager \
        nmap \
        nodejs \
        noto-fonts-cjk \
        noto-fonts-emoji \
        npm \
        nss-mdns \
        nwg-displays \
        nwg-look \
        papirus-icon-theme \
        pass \
        pass-otp \
        pipewire \
        pipewire-alsa \
        pipewire-jack \
        pipewire-pulse \
        power-profiles-daemon \
        python-tldextract \
        qalculate-qt \
        qt5-wayland \
        qt6-wayland \
        reflector \
        ripgrep \
        rofi \
        rsync \
        rustup \
        sbctl \
        slurp \
        snapshot \
        sof-firmware \
        speedtest-cli \
        starship \
        stow \
        swaync \
        swayosd \
        tealdeer \
        terminus-font \
        thunderbird \
        tmux \
        traceroute \
        ttf-hack \
        ttf-hack-nerd \
        ttf-noto-nerd \
        ttf-roboto \
        ttf-roboto-mono \
        ttf-roboto-mono-nerd \
        ufw \
        unzip \
        usbutils \
        vieb-bin \
        waybar \
        wget \
        wireless-regdb \
        wiremix \
        wireplumber \
        wl-clipboard \
        woff2-font-awesome \
        wtype \
        xdg-desktop-portal-gtk \
        xdg-desktop-portal-hyprland \
        yt-dlp \
        zerotier-one \
        zoxide

    export DOTROOT="$HOME/.files/.root"
    declare -a FILES=(
        "etc/kanata.kbd"
        "etc/ly/config.ini"
        "etc/mkinitcpio.conf"
        "etc/mkinitcpio.d/linux.preset"
        "etc/pacman.conf"
        "etc/systemd/logind.conf"
        "etc/systemd/sleep.conf"
        "etc/systemd/system/power-check.service"
        "etc/systemd/system/power-check.timer"
        "etc/udev/rules.d/99-power-profiles.rules"
        "etc/vconsole.conf"
        "usr/bin/auto-power-profile"
    )

    for FILE_PATH in "${FILES[@]}"; do
        sudo cp "$DOTROOT/$FILE_PATH" "/$FILE_PATH"
    done

    sudo mkinitcpio -P
    sudo sync

    sudo udevadm control --reload-rules
    sudo udevadm trigger

    sudo systemctl unmask systemd-rfkill.socket
    sudo systemctl unmask systemd-rfkill.service
    sudo systemctl unmask power-profiles-daemon.service
    sudo systemctl disable display-manager.service 2>/dev/null || true

    sudo systemctl enable ly@tty2.service

    sudo systemctl enable NetworkManager.service
    sudo systemctl enable NetworkManager-dispatcher.service
    sudo systemctl enable avahi-daemon.service
    sudo systemctl enable bluetooth.service
    sudo systemctl enable kanata.service
    sudo systemctl enable power-check.timer
    sudo systemctl enable power-profiles-daemon.service
    sudo systemctl enable ufw.service

    sudo ufw allow http
    sudo ufw allow https
    sudo ufw allow ssh
    sudo ufw allow mdns
    sudo ufw allow 42069                                      # COT
    sudo ufw allow 9993/udp                                   # zerotier port
    sudo ufw allow proto udp from any to any port 27031:27036 # steam
    sudo ufw allow proto tcp from any to any port 27040       # steam

    echo "y" | sudo ufw enable
    sudo ufw status
fi

if command -v dnf >/dev/null; then
    sudo dnf install -y \
        alacritty \
        bat \
        eza \
        fastfetch \
        fd-find \
        fish \
        fzf \
        git \
        neovim \
        nodejs \
        npm \
        ripgrep \
        stow \
        tealdeer \
        tmux \
        unzip \
        zoxide
fi

if command -v brew >/dev/null; then
    CI=1 brew install \
        alacritty \
        bat \
        bear \
        btop \
        eza \
        fastfetch \
        fd \
        fish \
        fzf \
        git \
        lazygit \
        neovim \
        nodejs \
        npm \
        ripgrep \
        rustup \
        starship \
        stow \
        tealdeer \
        tmux \
        unzip \
        zoxide
fi

if command -v apt-get >/dev/null; then
    sudo apt-get update

    sudo apt-get install -y \
        alacritty \
        bat \
        bear \
        btop \
        duf \
        eza \
        fastfetch \
        fd-find \
        fish \
        fzf \
        git \
        libssl-dev \
        neovim \
        nodejs \
        npm \
        pkg-config \
        python3 \
        python3-venv \
        ripgrep \
        rustup \
        stow \
        tealdeer \
        tmux \
        unzip \
        zoxide
fi

if command -v nvim >/dev/null; then
    sudo ln -sf "$(which nvim)" "/usr/local/bin/vi"
    sudo ln -sf "$(which nvim)" "/usr/local/bin/vim"
    sudo ln -sf "$(which nvim)" "/usr/local/bin/v"
fi

rustup install stable
rustup default stable

cargo install quoty
cargo install fnm

touch "$HOME/.files/.deps.lock"
