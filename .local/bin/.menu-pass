#!/usr/bin/env bash
# vi: ft=bash

MODES=("auth" "user" "pass" "otp")
PASSWORD_STORE_DIR="${PASSWORD_STORE_DIR:-$HOME/.password-store/}"
MODE=${1:-pass}
FILTER=${2:""}

if [[ ! " ${MODES[*]} " =~ \ ${MODE}\  ]]; then
    echo "Unsupported mode: $MODE" >&2
    exit 1
fi

entries=$(find "$PASSWORD_STORE_DIR" -name "*.gpg" | sed "s|$PASSWORD_STORE_DIR||;s|\.gpg$||")

if [[ -n "$FILTER" ]]; then
    entries=$(echo "$entries" | grep -i "$FILTER")
fi

selection=$(echo "$entries" | rofi -dmenu -p "[$MODE]" -i)
[[ -z "$selection" ]] && exit 1

if [[ "$MODE" == "auth" ]]; then
    user=$(basename "$selection")
    pass=$(pass show "$selection" | head -n 1)
    wtype "$user"
    sleep 0.1

    wtype -k Tab
    sleep 0.1

    wtype "$pass"
    sleep 0.1

    wtype -k Return
    exit 0
elif [[ "$MODE" == "user" ]]; then
    token=$(basename "$selection")
elif [[ "$MODE" == "pass" ]]; then
    token=$(pass show "$selection" | head -n 1)
elif [[ "$MODE" == "otp" ]]; then
    token=$(pass otp "$selection")
fi

wtype "$token"
sleep 0.1

wtype -k Return
