#!/usr/bin/env bash
# vi: ft=bash

PASSWORD_STORE_DIR="${PASSWORD_STORE_DIR:-$HOME/.password-store/}"
MODE=${1:-pass}
FILTER=${2:""}

entries=$(find "$PASSWORD_STORE_DIR" -name "*.gpg" | sed "s|$PASSWORD_STORE_DIR||;s|\.gpg$||")

if [[ -n "$FILTER" ]]; then
    entries=$(echo "$entries" | grep -i "$FILTER")
fi

selection=$(echo "$entries" | rofi -dmenu -p "[$MODE] Select Entry" -i)
[[ -z "$selection" ]] && exit 1

if [[ "$MODE" == "otp" ]]; then
    token=$(pass otp "$selection")
else
    token=$(pass show "$selection" | head -n 1)
fi

if [[ -n "$token" ]]; then
    echo -n "$token" | wl-copy

    wtype "$token"
fi
